#!/usr/bin/env perl

use common::sense;


use AnyEvent::Loop; # FIXME: EV not playing nice with Net::OpenSSH < 0.71
#use EV;
use AnyEvent;
use Getopt::Long;

use Vmprobe::Daemon;
use Vmprobe::Daemon::Util;
use Vmprobe::Daemon::API;



die "must not run as root"
    if $< == 0 || $> == 0;



my $o = {
    config_file => '/etc/vmprobed/vmprobed.conf',
};

my @getopt_specs = (
    'config|c=s',
    'nodaemon',
    'help|h|?',
);

Getopt::Long::GetOptionsFromArray(\@ARGV, $o, @getopt_specs)
    || die "error in command-line arguments";

if ($o->{help}) {
    print <<END;

vmprobed $Vmprobe::Daemon::VERSION

Usage:
    vmprobed [options]

Options:
    --config/-c <path vmprobed config file>
    --nodaemon
    --help/-h/-?

END
    exit 0;
}

Vmprobe::Daemon::Util::load_config($o->{config_file});




my $api;

if (config->{api}) {
    $api = Vmprobe::Daemon::API->new(%$o);
}

AE::cv->recv;
